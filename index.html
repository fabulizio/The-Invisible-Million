<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>The Invisible Million</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: sans-serif;
    }
    #container {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    #coordinates {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255,255,255,0.8);
      padding: 5px 10px;
      border-radius: 5px;
      z-index: 10;
      font-size: 14px;
    }
    #minimap {
      height: 150px;
      width: 150px;
      background: #eee;
      border: 1px solid #ccc;
      position: absolute;
      right: 10px;
      top: 10px;
      z-index: 10;
      cursor: pointer;
    }
    #zoomableGrid {
      flex: 1;
      background: #fff;
      touch-action: none;
    }
    #joystick {
      position: absolute;
      bottom: 10px;
      left: 10px;
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: rgba(0,0,0,0.1);
      z-index: 10;
      touch-action: none;
    }
    #joystickHandle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #333;
      position: absolute;
      top: 30px;
      left: 30px;
    }
    #zoomSlider {
      position: absolute;
      right: 10px;
      bottom: 10px;
      z-index: 10;
      transform: rotate(-90deg);
      transform-origin: right bottom;
    }
    #colorPicker {
      position: absolute;
      top: 10px;
      left: 160px;
      z-index: 10;
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="coordinates">x: 0, y: 0</div>
    <input type="color" id="colorPicker" value="#ff0000" />
    <canvas id="minimap" width="150" height="150"></canvas>
    <canvas id="zoomableGrid" width="1000" height="1000"></canvas>
    <div id="joystick">
      <div id="joystickHandle"></div>
    </div>
    <input type="range" id="zoomSlider" min="0.1" max="5" step="0.1" value="1" />
  </div>

  <script>
    const canvas = document.getElementById("zoomableGrid");
    const ctx = canvas.getContext("2d");
    const minimap = document.getElementById("minimap");
    const miniCtx = minimap.getContext("2d");
    const coordinates = document.getElementById("coordinates");
    const colorPicker = document.getElementById("colorPicker");
    const zoomSlider = document.getElementById("zoomSlider");

    let scale = 1;
    let offsetX = 0;
    let offsetY = 0;
    let isDragging = false;
    let dragStart = { x: 0, y: 0 };
    const gridSize = 1000;
    const tileSize = 20;
    const API_URL = "https://155ca338-0e90-4f5a-88ec-b6163921baae-00-181dgn4pq10j7.janeway.replit.dev";

    let painted = {};

    async function loadPainted() {
      const res = await fetch(`${API_URL}/painted`);
      painted = await res.json();
      draw();
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.save();
      ctx.translate(offsetX, offsetY);
      ctx.scale(scale, scale);

      for (let x = 0; x < gridSize; x++) {
        for (let y = 0; y < gridSize; y++) {
          const key = `${x},${y}`;
          if (painted[key]) {
            ctx.fillStyle = painted[key].color;
            ctx.fillRect(x * tileSize, y * tileSize, tileSize, tileSize);
          } else {
            ctx.fillStyle = "#fff";
            ctx.fillRect(x * tileSize, y * tileSize, tileSize, tileSize);
          }
          ctx.strokeStyle = "#ddd";
          ctx.strokeRect(x * tileSize, y * tileSize, tileSize, tileSize);
        }
      }
      ctx.restore();

      drawMinimap();
    }

    function drawMinimap() {
      miniCtx.clearRect(0, 0, minimap.width, minimap.height);
      const miniScale = minimap.width / (gridSize * tileSize);
      miniCtx.fillStyle = "#999";
      for (const key in painted) {
        const [x, y] = key.split(",").map(Number);
        miniCtx.fillRect(x * tileSize * miniScale, y * tileSize * miniScale, tileSize * miniScale, tileSize * miniScale);
      }

      // Draw red viewport
      miniCtx.strokeStyle = "red";
      miniCtx.lineWidth = 2;
      const w = canvas.width / scale * miniScale;
      const h = canvas.height / scale * miniScale;
      const x = -offsetX / scale * miniScale;
      const y = -offsetY / scale * miniScale;
      miniCtx.strokeRect(x, y, w, h);
    }

    canvas.addEventListener("mousedown", (e) => {
      isDragging = true;
      dragStart = { x: e.clientX, y: e.clientY };
    });

    canvas.addEventListener("mouseup", () => isDragging = false);
    canvas.addEventListener("mouseleave", () => isDragging = false);

    canvas.addEventListener("mousemove", (e) => {
      if (isDragging) {
        offsetX += e.clientX - dragStart.x;
        offsetY += e.clientY - dragStart.y;
        dragStart = { x: e.clientX, y: e.clientY };
        draw();
      }

      const x = Math.floor((e.offsetX - offsetX) / (tileSize * scale));
      const y = Math.floor((e.offsetY - offsetY) / (tileSize * scale));
      coordinates.textContent = `x: ${x}, y: ${y}`;
    });

    canvas.addEventListener("click", async (e) => {
      const x = Math.floor((e.offsetX - offsetX) / (tileSize * scale));
      const y = Math.floor((e.offsetY - offsetY) / (tileSize * scale));
      const color = colorPicker.value;
      const key = `${x},${y}`;
      if (!painted[key]) {
        const res = await fetch(`${API_URL}/paint`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ x, y, color })
        });
        if (res.ok) {
          painted[key] = { color };
          draw();
        }
      }
    });

    minimap.addEventListener("click", (e) => {
      const miniScale = minimap.width / (gridSize * tileSize);
      const x = e.offsetX / miniScale;
      const y = e.offsetY / miniScale;
      offsetX = -x * scale + canvas.width / 2;
      offsetY = -y * scale + canvas.height / 2;
      draw();
    });

    zoomSlider.addEventListener("input", () => {
      scale = parseFloat(zoomSlider.value);
      draw();
    });

    // Joystick
    const joystick = document.getElementById("joystick");
    const handle = document.getElementById("joystickHandle");
    let joyInterval = null;

    joystick.addEventListener("pointerdown", (e) => {
      handle.setPointerCapture(e.pointerId);
      joyInterval = setInterval(() => {
        const rect = joystick.getBoundingClientRect();
        const dx = e.clientX - (rect.left + rect.width / 2);
        const dy = e.clientY - (rect.top + rect.height / 2);
        offsetX += dx * 0.05;
        offsetY += dy * 0.05;
        draw();
      }, 16);
    });

    joystick.addEventListener("pointerup", () => {
      clearInterval(joyInterval);
      joyInterval = null;
    });

    loadPainted();
  </script>
</body>
</html>
