<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The Invisible Million</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #111;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    canvas {
      background: #222;
      touch-action: none;
    }
    #controls {
      margin: 10px;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    #joystick {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 2px solid #555;
      position: relative;
      touch-action: none;
    }
    #joystick .thumb {
      width: 40px;
      height: 40px;
      background: #ccc;
      border-radius: 50%;
      position: absolute;
      left: 20px;
      top: 20px;
      transform: translate(-50%, -50%);
    }
    #colorPickerContainer {
      position: relative;
    }
    #colorInput {
      width: 0;
      height: 0;
      opacity: 0;
      position: absolute;
    }
    #colorPreview {
      width: 30px;
      height: 30px;
      border: 2px solid white;
      border-radius: 5px;
      cursor: pointer;
      background-color: #ff0000;
    }
    #zoomSlider {
      width: 100px;
    }
  </style>
</head>
<body>
  <h1>The Invisible Million</h1>

  <div id="controls">
    <div id="colorPickerContainer">
      <input type="color" id="colorInput" value="#ff0000" />
      <div id="colorPreview"></div>
    </div>
    <input type="range" id="zoomSlider" min="0.5" max="10" step="0.1" value="1" />
    <div id="joystick">
      <div class="thumb"></div>
    </div>
  </div>

  <canvas id="gridCanvas" width="800" height="800"></canvas>

  <script>
    const canvas = document.getElementById("gridCanvas");
    const ctx = canvas.getContext("2d");
    const zoomSlider = document.getElementById("zoomSlider");
    const colorInput = document.getElementById("colorInput");
    const colorPreview = document.getElementById("colorPreview");

    let zoom = 1;
    let offsetX = 0;
    let offsetY = 0;
    let isDragging = false;
    let dragStartX, dragStartY;
    const cellSize = 20;
    const gridSize = 1000;
    let paintedCells = {}; // local cache

    // Paint color logic
    colorPreview.onclick = () => colorInput.click();
    colorInput.oninput = (e) => {
      colorPreview.style.backgroundColor = e.target.value;
    };

    // Slider control
    zoomSlider.oninput = (e) => {
      zoom = parseFloat(e.target.value);
    };

    // Load painted squares initially
    fetch("https://your-backend-url/painted")
      .then((res) => res.json())
      .then((data) => {
        paintedCells = data;
        requestAnimationFrame(draw);
      });

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const visibleCols = Math.ceil(canvas.width / (cellSize * zoom));
      const visibleRows = Math.ceil(canvas.height / (cellSize * zoom));
      const startX = Math.floor(offsetX);
      const startY = Math.floor(offsetY);

      for (let y = startY; y < startY + visibleRows; y++) {
        for (let x = startX; x < startX + visibleCols; x++) {
          if (x >= 0 && y >= 0 && x < gridSize && y < gridSize) {
            const px = (x - offsetX) * cellSize * zoom;
            const py = (y - offsetY) * cellSize * zoom;
            ctx.strokeStyle = "#444";
            ctx.strokeRect(px, py, cellSize * zoom, cellSize * zoom);
            const key = `${x},${y}`;
            if (paintedCells[key]) {
              ctx.fillStyle = paintedCells[key].color;
              ctx.fillRect(px, py, cellSize * zoom, cellSize * zoom);
            }
          }
        }
      }
      requestAnimationFrame(draw);
    }

    // Click to paint
    canvas.addEventListener("click", (e) => {
      const rect = canvas.getBoundingClientRect();
      const x = Math.floor(e.clientX - rect.left);
      const y = Math.floor(e.clientY - rect.top);
      const gridX = Math.floor(x / (cellSize * zoom) + offsetX);
      const gridY = Math.floor(y / (cellSize * zoom) + offsetY);
      const key = `${gridX},${gridY}`;

      if (!paintedCells[key]) {
        const color = colorInput.value;
        fetch("https://your-backend-url/paint", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ x: gridX, y: gridY, color })
        }).then((res) => {
          if (res.ok) {
            paintedCells[key] = { color };
          }
        });
      }
    });

    // Drag to move grid
    canvas.addEventListener("mousedown", (e) => {
      isDragging = true;
      dragStartX = e.clientX;
      dragStartY = e.clientY;
    });
    window.addEventListener("mouseup", () => (isDragging = false));
    window.addEventListener("mousemove", (e) => {
      if (isDragging) {
        const dx = (e.clientX - dragStartX) / (cellSize * zoom);
        const dy = (e.clientY - dragStartY) / (cellSize * zoom);
        offsetX -= dx;
        offsetY -= dy;
        dragStartX = e.clientX;
        dragStartY = e.clientY;
      }
    });

    // Joystick logic
    const joystick = document.getElementById("joystick");
    const thumb = joystick.querySelector(".thumb");
    let joyActive = false;

    joystick.addEventListener("pointerdown", (e) => {
      joyActive = true;
      thumb.style.left = e.offsetX + "px";
      thumb.style.top = e.offsetY + "px";
    });

    window.addEventListener("pointerup", () => {
      joyActive = false;
      thumb.style.left = "20px";
      thumb.style.top = "20px";
    });

    window.addEventListener("pointermove", (e) => {
      if (joyActive) {
        const dx = (e.clientX - joystick.getBoundingClientRect().left - 40) / 100;
        const dy = (e.clientY - joystick.getBoundingClientRect().top - 40) / 100;
        offsetX += dx;
        offsetY += dy;
      }
    });
  </script>
</body>
</html>
